# 📷 摄像头切换功能文档

## 概述

摄像头切换功能允许用户在前置和后置摄像头之间无缝切换，为姿态估计提供更灵活的视角选择。

## 功能特性

### ✨ 核心功能
- **智能切换**: 自动检测设备摄像头数量，仅在支持的设备上显示切换按钮
- **状态反馈**: 提供清晰的视觉反馈，包括切换动画和状态图标
- **错误处理**: 完善的错误处理机制，提供用户友好的错误信息
- **性能监控**: 实时监控切换性能，优化用户体验

### 🎨 用户界面
- **位置**: 位于canvas右上角的圆形按钮
- **图标**: 
  - 🤳 前置摄像头
  - 📷 后置摄像头
  - 🔄 切换中
  - ❌ 错误状态
- **交互**: 点击切换，悬停显示提示信息

## 技术架构

### 📁 文件结构
```
src/
├── components/
│   ├── CameraManager.js          # 摄像头管理器
│   ├── PoseEstimator.js          # 姿态估计器（集成摄像头功能）
│   └── UIManager.js              # UI管理器（摄像头按钮）
├── utils/
│   ├── cameraErrors.js           # 摄像头错误处理
│   ├── cameraPerformanceMonitor.js # 性能监控
│   ├── cameraTestUtils.js        # 测试工具
│   └── constants.js              # 配置常量
└── types/
    └── camera.d.ts               # TypeScript类型定义
```

### 🔧 核心类

#### CameraManager
负责摄像头的底层管理：
- 设备枚举和检测
- 摄像头初始化和切换
- 资源管理和清理

#### PoseEstimator
集成摄像头功能的姿态估计器：
- 摄像头状态管理
- 切换过程中的检测暂停/恢复
- 性能优化

#### UIManager
用户界面管理：
- 切换按钮创建和管理
- 状态显示和用户反馈
- 事件处理

## 使用指南

### 🚀 基本使用

1. **自动初始化**: 应用启动时自动检测摄像头支持
2. **按钮显示**: 仅在支持多摄像头的设备上显示切换按钮
3. **点击切换**: 点击按钮在前置/后置摄像头间切换

### ⚙️ 配置选项

在 `constants.js` 中可配置：

```javascript
CAMERA: {
    ADVANCED: {
        SWITCH_TIMEOUT: 5000,        // 切换超时时间
        MAX_RETRY_COUNT: 3,          // 最大重试次数
        RETRY_DELAY: 1000,           // 重试延迟
        AUTO_ADJUST: {
            ENABLED: true,           // 启用自动调整
            PERFORMANCE_THRESHOLD: 50 // 性能阈值
        }
    },
    ERROR_HANDLING: {
        AUTO_RETRY: true,            // 自动重试
        FALLBACK_ENABLED: true,      // 降级策略
        USER_FRIENDLY_MESSAGES: true // 用户友好提示
    }
}
```

### 🔍 调试和测试

#### 快捷键
- `Ctrl+Shift+T`: 打开摄像头测试面板

#### 测试功能
- **基础功能测试**: 检查摄像头API支持
- **切换功能测试**: 验证多摄像头切换
- **完整诊断**: 生成详细的诊断报告

#### 控制台命令
```javascript
// 获取摄像头状态
window.poseApp.poseEstimator.getStatus()

// 手动切换摄像头
await window.poseApp.poseEstimator.switchCamera()

// 检查切换支持
await window.poseApp.poseEstimator.checkCameraSwitchSupport()
```

## 错误处理

### 🚨 常见错误类型

| 错误代码 | 描述 | 解决方案 |
|---------|------|---------|
| `PERMISSION_DENIED` | 摄像头权限被拒绝 | 检查浏览器权限设置 |
| `DEVICE_NOT_FOUND` | 未找到摄像头设备 | 检查硬件连接 |
| `SWITCH_NOT_SUPPORTED` | 不支持摄像头切换 | 设备只有一个摄像头 |
| `SWITCH_TIMEOUT` | 切换操作超时 | 重试或检查设备状态 |
| `DEVICE_IN_USE` | 摄像头被其他应用占用 | 关闭其他应用 |

### 🛠️ 错误恢复机制

1. **自动重试**: 失败时自动重试指定次数
2. **降级策略**: 高分辨率失败时自动降级
3. **用户提示**: 提供清晰的错误信息和解决建议
4. **状态恢复**: 错误后自动恢复到之前的工作状态

## 性能优化

### 📊 性能监控

- **切换时间**: 监控每次切换的耗时
- **成功率**: 统计切换成功率
- **错误频率**: 跟踪错误发生频率
- **资源使用**: 监控内存和CPU使用

### ⚡ 优化策略

1. **预加载**: 预先检测可用设备
2. **缓存**: 缓存设备信息避免重复查询
3. **异步处理**: 非阻塞的切换操作
4. **资源清理**: 及时释放不用的视频流

## 兼容性

### 🌐 浏览器支持

| 浏览器 | 版本要求 | 支持状态 |
|--------|---------|---------|
| Chrome | 53+ | ✅ 完全支持 |
| Firefox | 36+ | ✅ 完全支持 |
| Safari | 11+ | ✅ 完全支持 |
| Edge | 12+ | ✅ 完全支持 |

### 📱 设备支持

- **桌面**: 支持外接多摄像头
- **笔记本**: 支持内置+外接摄像头
- **手机**: 支持前置+后置摄像头
- **平板**: 支持前置+后置摄像头

## 最佳实践

### 👍 推荐做法

1. **权限请求**: 在用户交互后请求摄像头权限
2. **错误处理**: 始终提供降级方案
3. **用户反馈**: 提供清晰的状态指示
4. **性能监控**: 定期检查切换性能
5. **测试覆盖**: 在不同设备上测试功能

### ❌ 避免事项

1. **频繁切换**: 避免短时间内多次切换
2. **忽略错误**: 不要忽略切换失败的情况
3. **阻塞UI**: 切换过程不应阻塞用户界面
4. **资源泄漏**: 确保及时清理视频流资源

## 故障排除

### 🔧 常见问题

**Q: 切换按钮不显示？**
A: 检查设备是否有多个摄像头，或查看控制台错误信息。

**Q: 切换失败？**
A: 检查摄像头权限，确保没有其他应用占用摄像头。

**Q: 切换速度慢？**
A: 检查网络连接，考虑降低视频分辨率。

**Q: 权限被拒绝？**
A: 在浏览器地址栏点击摄像头图标，选择"允许"。

### 📞 技术支持

如遇到其他问题，请：
1. 使用 `Ctrl+Shift+T` 运行诊断工具
2. 查看浏览器控制台错误信息
3. 提供设备和浏览器版本信息