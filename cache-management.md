# 缓存管理指南

## 问题描述

当您修改了 JavaScript 代码后，可能会遇到以下情况：
- 页面没有反映最新的代码更改
- 功能表现与预期不符
- 控制台显示旧版本的日志信息

这通常是由于浏览器缓存或 Service Worker 缓存导致的。

## 解决方案

### 1. 使用强制刷新按钮（推荐）

在参数控制面板中，我们添加了一个红色的**"强制刷新"**按钮：
- 点击该按钮会清除所有缓存并重新加载页面
- 确保获取最新版本的 JavaScript 代码
- 适用于开发和生产环境

### 2. 使用键盘快捷键

按下 `Ctrl + Shift + R`：
- 快速触发强制刷新功能
- 与强制刷新按钮效果相同
- 开发者友好的快捷操作

### 3. 浏览器原生方法

#### Chrome/Edge:
- `Ctrl + Shift + R` 或 `Ctrl + F5`：硬刷新
- `F12` 打开开发者工具 → Network 标签 → 勾选 "Disable cache"

#### Firefox:
- `Ctrl + Shift + R` 或 `Ctrl + F5`：硬刷新
- `F12` 打开开发者工具 → Network 标签 → 点击设置图标 → 勾选 "Disable Cache"

#### Safari:
- `Cmd + Shift + R`：硬刷新
- 开发菜单 → 清空缓存

### 4. 手动清除浏览器缓存

#### Chrome/Edge:
1. 按 `Ctrl + Shift + Delete`
2. 选择时间范围
3. 勾选 "缓存的图片和文件"
4. 点击 "清除数据"

#### Firefox:
1. 按 `Ctrl + Shift + Delete`
2. 选择要清除的时间范围
3. 勾选 "缓存"
4. 点击 "立即清除"

## 技术实现

### Service Worker 缓存策略

我们实现了智能缓存策略：

1. **JavaScript 文件**：使用网络优先策略
   - 优先从网络获取最新版本
   - 网络失败时回退到缓存
   - 确保 JS 代码始终是最新的

2. **其他资源**：使用缓存优先策略
   - 提高加载速度
   - 减少网络请求
   - 保持离线可用性

### 缓存版本管理

- Service Worker 使用版本号 `pose-estimator-v1.0.1`
- 每次更新会自动清理旧缓存
- 支持强制清除所有缓存

### 自动更新检测

- 检测到新版本时会提示用户更新
- 支持静默更新和手动确认更新
- 更新完成后自动重新加载页面

## 开发建议

### 1. 开发环境

在本地开发时：
```javascript
// 在控制台中禁用缓存
if (window.location.hostname === 'localhost') {
    console.log('开发模式：建议在开发者工具中禁用缓存');
}
```

### 2. 版本控制

每次发布新版本时：
1. 更新 Service Worker 中的 `CACHE_NAME` 版本号
2. 测试强制刷新功能
3. 验证缓存清理是否正常工作

### 3. 调试技巧

使用浏览器开发者工具：
1. **Application/应用** 标签 → **Service Workers**
   - 查看 Service Worker 状态
   - 手动注销和重新注册

2. **Application/应用** 标签 → **Storage**
   - 查看缓存内容
   - 手动删除特定缓存

3. **Network/网络** 标签
   - 监控资源加载
   - 检查缓存命中情况

## 常见问题

### Q: 强制刷新后仍然看到旧代码？
A: 可能需要：
1. 完全关闭浏览器重新打开
2. 检查是否有多个标签页打开
3. 清除浏览器的所有数据

### Q: Service Worker 无法注册？
A: 确保：
1. 使用 HTTPS 或 localhost
2. Service Worker 文件路径正确
3. 浏览器支持 Service Worker

### Q: 缓存清除功能不工作？
A: 检查：
1. 浏览器控制台是否有错误
2. Service Worker 是否正常运行
3. 网络连接是否正常

## 最佳实践

1. **开发时**：始终在开发者工具中禁用缓存
2. **测试时**：使用强制刷新功能验证更新
3. **部署时**：更新 Service Worker 版本号
4. **用户反馈**：提供清晰的缓存清理指导

## 监控和日志

应用会在控制台输出相关日志：
```
Service Worker: 安装中...
Service Worker: 缓存文件
Service Worker: 激活中...
Service Worker: 删除旧缓存
缓存已清除，正在刷新页面...
```

通过这些日志可以了解缓存管理的执行情况。